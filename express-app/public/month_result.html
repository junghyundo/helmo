<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helmo 월별 안전 관리 분석</title>
    <!-- 기본 스타일 (Tailwind CSS 대신) -->
    <style>
        /* 기본 리셋 및 Tailwind 스타일 대체 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; padding: 1rem; }
        .bg-white { background-color: white; }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .rounded-xl { border-radius: 0.75rem; }
        .p-6 { padding: 1.5rem; }
        .p-10 { padding: 2.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .my-8 { margin-top: 2rem; margin-bottom: 2rem; }
        .max-w-4xl { max-width: 56rem; }
        .w-full { width: 100%; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .top-4 { top: 1rem; }
        .left-4 { left: 1rem; }
        .top-8 { top: 2rem; }
        .left-8 { left: 2rem; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .hover\\:bg-gray-300:hover { background-color: #d1d5db; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .z-10 { z-index: 10; }
        .transition { transition-property: all; }
        .duration-150 { transition-duration: 150ms; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .text-gray-700 { color: #374151; }
        .font-semibold { font-weight: 600; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-10 { margin-bottom: 2.5rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .font-extrabold { font-weight: 800; }
        .font-bold { font-weight: 700; }
        .text-gray-900 { color: #111827; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-800 { color: #1f2937; }
        .w-32 { width: 8rem; }
        .text-center { text-align: center; }
        .bg-blue-600 { background-color: #2563eb; }
        .hover\\:bg-blue-700:hover { background-color: #1d4ed8; }
        .text-white { color: white; }
        .disabled\\:bg-gray-300:disabled { background-color: #d1d5db; }
        .disabled\\:cursor-not-allowed:disabled { cursor: not-allowed; }
        .h-5 { height: 1.25rem; }
        .w-5 { width: 1.25rem; }
        .h-12 { height: 3rem; }
        .w-12 { width: 3rem; }
        .bg-blue-500 { background-color: #3b82f6; }
        button { cursor: pointer; border: none; }
        button:disabled { opacity: 0.6; }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom font import for better Korean display */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Chart container styling for responsiveness */
        .chart-container {
            position: relative;
            height: 40vh; /* Responsive height */
            width: 90vw; /* Responsive width */
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-50 p-4">
    <!-- 메인 컨테이너에 relative 클래스 추가 -->
    <div class="relative w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 mx-auto my-8">
        
        <!-- 메인 페이지로 이동 버튼 -->
        <button onclick="goToCalendarPage()" class="absolute top-4 left-4 bg-gray-200 hover:bg-gray-300 rounded-lg shadow-md z-10 transition duration-150 md:top-8 md:left-8 px-4 py-2 text-gray-700 font-semibold">
            <span>← 메인 화면</span>
        </button>

        <!-- Header -->
        <div class="flex flex-col items-center">
            <img src="https://placehold.co/50x50/007bff/ffffff?text=AI" alt="AI Icon" class="h-12 w-12 mb-4 rounded-full bg-blue-500 p-2">
            <div class="text-3xl font-extrabold text-gray-900 mb-2">Helmo 안전 관리</div>
            <div class="text-lg text-gray-600 mb-8">이미지 기반 안전모 착용 현황 분석</div>
        </div>

        <!-- Month Navigation -->
        <div class="flex items-center justify-center gap-4 mb-10">
            <button id="prevBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 disabled:bg-gray-300 disabled:cursor-not-allowed" onclick="prevMonth()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            </button>
            <span id="monthLabel" class="text-xl font-bold text-gray-800 w-32 text-center">2024년 1월</span>
            <button id="nextBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 disabled:bg-gray-300 disabled:cursor-not-allowed" onclick="nextMonth()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </button>
        </div>

        <!-- Key Metric Cards -->
        <div class="flex flex-wrap justify-center gap-6 mb-12">
            
            <div class="flex flex-col items-center bg-blue-50 border border-blue-200 rounded-xl shadow-lg p-5 w-40 md:w-48 transition hover:shadow-xl">
                <h3 class="text-sm font-medium text-blue-600 mb-1">월간 평균 착용률</h3>
                <p id="rate" class="text-3xl font-extrabold text-blue-800">-</p>
            </div>
            
            <div class="flex flex-col items-center bg-white border border-gray-200 rounded-xl shadow-lg p-5 w-40 md:w-48 transition hover:shadow-xl">
                <h3 class="text-sm font-medium text-gray-500 mb-1">총 감지 인원</h3>
                <p id="detected" class="text-3xl font-extrabold text-gray-900">-</p>
            </div>
            
            <div class="flex flex-col items-center bg-white border border-gray-200 rounded-xl shadow-lg p-5 w-40 md:w-48 transition hover:shadow-xl">
                <h3 class="text-sm font-medium text-gray-500 mb-1">안전모 착용 인원</h3>
                <p id="wearing" class="text-3xl font-extrabold text-gray-900">-</p>
            </div>
            
            <div id="gradeCard" class="flex flex-col items-center bg-green-50 border border-green-300 rounded-xl shadow-lg p-5 w-40 md:w-48 transition hover:shadow-xl">
                <h3 class="text-sm font-medium text-green-700 mb-1">안전 관리 등급</h3>
                <p id="grade" class="text-3xl font-extrabold text-green-800">-</p>
            </div>
        </div>

        <!-- Chart -->
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-left border-b pb-2">주간 안전모 착용률 추이</h3>
        <div class="chart-container bg-gray-50 p-4 rounded-xl shadow-inner">
            <canvas id="helmetChart"></canvas>
        </div>
    </div>

    <script>
        // 전역 변수 설정
        let currentYear;
        let currentMonth;
        let helmetChart;
        let isLoading = false; // 로딩 상태 변수 추가

        // --- 네비게이션 함수 ---
        /**
         * 메인 캘린더/기록 페이지로 이동합니다.
         */
        function goToCalendarPage() {
            // index.html로 페이지를 실제로 이동합니다.
            window.location.href = 'index.html';
        }

        /**
         * 특정 월의 안전 데이터를 가져옵니다 (더미 데이터 사용)
         * @param {number} year 요청 연도
         * @param {number} month 요청 월
         * @returns {Promise<object>} 처리된 데이터 객체
         */
        async function fetchSafetyData(year, month) {
            try {
                // 더미 데이터 생성 (실제 API 대신)
                const data = generateDummyData(year, month);
                
                // 등급 카드 색상 결정 로직
                let gradeColor = 'text-red-800 border-red-300 bg-red-50';
                const rate = parseFloat(data.wearingRate); 
                
                if (rate >= 97) { gradeColor = 'text-green-800 border-green-300 bg-green-50'; }
                else if (rate >= 93) { gradeColor = 'text-yellow-800 border-yellow-300 bg-yellow-50'; }
                else if (rate >= 90) { gradeColor = 'text-orange-800 border-orange-300 bg-orange-50'; }

                // 주간 라벨 생성
                const weeklyLabels = data.weeklyRates.map((_, i) => `${i + 1}주차`);

                return {
                    wearingRate: `${rate.toFixed(1)}%`,
                    detectedCount: data.detectedCount.toLocaleString(),
                    wearingCount: data.wearingCount.toLocaleString(),
                    safetyGrade: data.safetyGrade,
                    gradeColor: gradeColor,
                    weeklyLabels: weeklyLabels,
                    weeklyRates: data.weeklyRates
                };
            } catch (error) {
                console.error(`Error fetching safety data for ${year}-${month}:`, error);
                
                // 오류 발생 시 오류 메시지 표시
                return {
                    wearingRate: "오류",
                    detectedCount: "오류",
                    wearingCount: "오류",
                    safetyGrade: "X",
                    gradeColor: 'text-red-800 border-red-300 bg-red-50',
                    weeklyLabels: ["1주차", "2주차", "3주차", "4주차"],
                    weeklyRates: [0, 0, 0, 0]
                };
            }
        }

        // --- 로딩 상태 UI 제어 ---
        function setLoading(state) {
            isLoading = state;
            const elements = ['rate', 'detected', 'wearing', 'grade', 'prevBtn', 'nextBtn'];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === 'prevBtn' || id === 'nextBtn') {
                        el.disabled = state; // 버튼 비활성화
                    } else if (id === 'grade') {
                        el.textContent = state ? '...' : el.textContent; // 로딩 중 표시
                    } else {
                        el.textContent = state ? '...' : el.textContent; // 로딩 중 표시
                    }
                }
            });
        }

        // --- 대시보드 업데이트 함수 (async로 변경) ---
        async function updateDashboard() {
            if (isLoading) return; // 이미 로딩 중이면 중복 실행 방지
            setLoading(true);

            // 1. 월 레이블 업데이트 (즉시 반영)
            document.getElementById("monthLabel").textContent = `${currentYear}년 ${currentMonth}월`;

            // 2. 데이터 비동기 호출
            const data = await fetchSafetyData(currentYear, currentMonth);

            // 3. 카드 데이터 업데이트
            document.getElementById("rate").textContent = data.wearingRate;
            document.getElementById("detected").textContent = data.detectedCount;
            document.getElementById("wearing").textContent = data.wearingCount;
            document.getElementById("grade").textContent = data.safetyGrade;

            // 4. 등급 카드 스타일 업데이트
            const gradeCard = document.getElementById("gradeCard");
            // 기존 색상 클래스 제거 (Tailwind Classes)
            gradeCard.className = gradeCard.className.replace(/(text-\w+-\d+|border-\w+-\d+|bg-\w+-\d+)/g, '').trim();
            // 새 등급 색상 클래스 추가
            gradeCard.className = `flex flex-col items-center rounded-xl shadow-lg p-5 w-40 md:w-48 transition hover:shadow-xl ${data.gradeColor}`;


            // 5. 차트 데이터 업데이트
            helmetChart.data.labels = data.weeklyLabels;
            helmetChart.data.datasets[0].data = data.weeklyRates;
            helmetChart.update();
            
            setLoading(false);
        }

        // --- 네비게이션 함수 (월 이동) ---
        function prevMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            updateDashboard();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            updateDashboard();
        }

        // --- 초기화 함수 ---
        function initialize() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth() + 1; // getMonth()는 0부터 시작하므로 +1

            // Chart.js 초기 설정
            const ctx = document.getElementById('helmetChart').getContext('2d');
            helmetChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // 초기 데이터 없음
                    datasets: [{
                        label: '착용률 (%)',
                        data: [], // 초기 데이터 없음
                        borderColor: '#3b82f6', // blue-500
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#1d4ed8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // 컨테이너 크기에 맞게 조절
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            title: { display: true, text: '착용률 (%)' }
                        },
                        x: {
                            title: { display: true, text: '주차' }
                        }
                    }
                }
            });
            
            // 초기 대시보드 렌더링
            updateDashboard();
        }

        /**
         * 더미 데이터 생성 함수
         * @param {number} year 연도
         * @param {number} month 월
         * @returns {object} 더미 안전 데이터
         */
        function generateDummyData(year, month) {
            // 월별로 다른 더미 데이터 생성
            const baseRate = 85 + (month % 10); // 85-94% 범위
            const detectedCount = 150 + (month * 10) + Math.floor(Math.random() * 50);
            const wearingCount = Math.floor(detectedCount * (baseRate / 100));
            
            // 주간 데이터 (4주차)
            const weeklyRates = [];
            for (let i = 0; i < 4; i++) {
                weeklyRates.push(baseRate + Math.floor(Math.random() * 10) - 5); // ±5% 변동
            }
            
            // 등급 계산
            let safetyGrade = 'D';
            if (baseRate >= 95) safetyGrade = 'A';
            else if (baseRate >= 90) safetyGrade = 'B';
            else if (baseRate >= 85) safetyGrade = 'C';
            
            return {
                wearingRate: baseRate,
                detectedCount: detectedCount,
                wearingCount: wearingCount,
                safetyGrade: safetyGrade,
                weeklyRates: weeklyRates
            };
        }

        // 페이지 로드 시 초기화
        window.onload = initialize;
    </script>
</body>
</html>
